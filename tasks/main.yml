---
- name: Install required packages
  loop:
    - unzip
  ansible.builtin.package:
    name: "{{ item }}"
    state: present
  tags:
    - cloud

- name: Download awscli installer
  when:
    - cloud_awscli_enabled
  ansible.builtin.unarchive:
    src: "{{ cloud_awscli_installer }}"
    dest: /usr/local/src
    remote_src: true
    owner: root
    group: root
  tags:
    - cloud
    - awscli

- name: Install awscli commands
  when:
    - cloud_awscli_enabled
  ansible.builtin.command:
    cmd: /usr/local/src/aws/install
    creates: /usr/local/bin/aws
  tags:
    - cloud
    - awscli

- name: Install s4cmd package
  when:
    - cloud_awscli_enabled
  ansible.builtin.package:
    name: s4cmd
    state: present
  tags:
    - cloud
    - awscli

- name: Download s5cmd release
  when:
    - cloud_s5cmd_enabled
  ansible.builtin.unarchive:
    src: "{{ cloud_s5cmd_download }}"
    dest: "{{ cloud_install_path }}"
    include:
      - s5cmd
    remote_src: true
    owner: root
    group: root
    mode: u=rwx,g=rx,o=rx
  tags:
    - cloud
    - s5cmd

- name: Download eksctl release
  when:
    - cloud_eksctl_enabled
  ansible.builtin.unarchive:
    src: "{{ cloud_eksctl_download }}"
    dest: "{{ cloud_install_path }}"
    include:
      - eksctl
    remote_src: true
    owner: root
    group: root
    mode: u=rwx,g=rx,o=rx
  tags:
    - cloud
    - eksctl

- name: Download hcloud release
  when:
    - cloud_hcloud_enabled
  ansible.builtin.unarchive:
    src: "{{ cloud_hcloud_download }}"
    dest: "{{ cloud_install_path }}"
    include:
      - hcloud
    remote_src: true
    owner: root
    group: root
    mode: u=rwx,g=rx,o=rx
  tags:
    - cloud
    - hcloud

- name: Download azure key
  when:
    - cloud_azure_enabled
  register: cloud_azure_key_download
  ansible.builtin.get_url:
    url: https://packages.microsoft.com/keys/microsoft.asc
    dest: "{{ cloud_azure_keyring }}.asc"
    mode: u=rw,g=r,o=r
    force: true
  tags:
    - cloud
    - azure

- name: Check azure key
  when:
    - cloud_azure_enabled
  register: cloud_azure_key_status
  ansible.builtin.stat:
    path: "{{ cloud_azure_keyring }}"
  tags:
    - cloud
    - azure

- name: Dearmor azure key
  when:
    - cloud_azure_enabled
    - cloud_azure_key_download.changed or not cloud_azure_key_status.stat.exists
  register: cloud_azure_key_convert
  changed_when: cloud_azure_key_convert.rc == 0
  ansible.builtin.command:
    cmd: "gpg --dearmor -o {{ cloud_azure_keyring }} {{ cloud_azure_keyring }}.asc"
  tags:
    - cloud
    - azure

- name: Add azure repository
  when:
    - cloud_azure_enabled
  ansible.builtin.apt_repository:
    repo: "deb [arch={{ cloud_azure_arch }} signed-by={{ cloud_azure_keyring }}] https://packages.microsoft.com/repos/azure-cli {{ ansible_distribution_release }} main"
    filename: azure
    update_cache: true
    state: present
  tags:
    - cloud
    - azure

- name: Install azure package
  when:
    - cloud_azure_enabled
  ansible.builtin.package:
    name: azure-cli
    state: present
  tags:
    - cloud
    - azure

...
